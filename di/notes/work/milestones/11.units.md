# Milestone 11: Units
## Next

- [x] string computations (eg, 5 1/4 inches)
	- [x] fractions for imperial (not metric)
- [x] parsing (string → mm)
- [x] incorporate into Render.ts
- [ ] editing within dimensionals

---

## Proposal: Units.ts

**Location:** `types/` — pac: conversion tables + symbols are data-driven like Angle, lives next to T_Unit enums. common/ is grab-bag utilities; types/ is domain primitives.

**File:** `di/src/lib/ts/types/Units.ts`
**Tests:** `di/src/lib/ts/tests/Units.test.ts`

### Storage model

All SO dimensions stored in **millimeters**. Display is formatting — like date/time stored in µs.

### Conversion table

Each T_Unit → factor in mm. One record, all 22 units. Examples: `inch: 25.4`, `meter: 1000`, `angstrom: 1e-7`, `fathom: 1828.8`, `cubit: 457.2`.

### Display symbols

Each T_Unit → display string. `inch: '"'`, `foot: "'"`, `millimeter: ' mm'`, `nautical_mile: ' nmi'`, etc.

### System membership

`system_units(system: T_Unit_System): T_Unit[]` — returns units belonging to a system. For UI dropdowns.

### Formatting (mm → string)

`format(mm: number, unit: T_Unit): string`

- **Metric/marine/archaic:** decimal. `1500 mm` in cm → `"150 cm"`. `457.2 mm` in cubits → `"1 cubit"`.
- **Imperial:** fractional. `133.35 mm` in inches → `"5 1/4\""`. Max denominator 64. Reduces (`2/4` → `1/2`). Negligible remainder (< 1/128") → whole number only.

### Compound display (imperial only)

`format_compound(mm: number): string`

Feet + fractional inches. Cascades larger → smaller within imperial.

| mm | output |
|---|---|
| 1600.2 | `5' 3"` |
| 1606.55 | `5' 3 1/4"` |
| 304.8 | `1'` |
| 25.4 | `1"` |
| 12.7 | `1/2"` |
| 0 | `0"` |

Rules: no feet if < 12". No inches if remainder is zero. Fractions reduce, max denominator 64. Metric/marine/archaic don't compound — always single unit decimal.

### Parsing (string → mm)

`parse(input: string, unit: T_Unit): number | null`

- **Metric:** parse decimal. `"5.25 cm"` → `52.5 mm`.
- **Imperial:** parse fractions. `"5 1/4"` in inches → `133.35 mm`. Also handles `"5.25"` as decimal inches.
- **Compound:** `"5' 3 1/4\""` → `1606.55 mm`. Detect `'` and `"` markers.
- Returns null for unparseable input. Tolerant of whitespace, optional unit suffix.

### SOT for unit preference

Unit system is a **display** choice, not a property of the geometry. Same object, different viewers — one sees inches, another sees mm. Like locale for date formatting.

**Where it lives:** Preferences (persisted) + Svelte store (reactive). Same pattern as `w_background_color`.

**Add to `managers/Preferences.ts`:**
```
T_Preference:
  unitSystem = 'unitSystem'
  unit       = 'unit'
```

**Defaults:** `inches` (matches storage — no conversion needed).

**Why not on the SO?** You don't want your door in inches and your window in cubits. Unit is a viewport/user concern, not per-object.

### What it doesn't do (yet)

- No SO integration — Render.ts would call `units.format(value, currentUnit)` instead of `value.toFixed(2)`, wired separately

## Done

- [x] enums
	- [x] inch, foot, yard, mile (imperial)
	- [x] angstrom, nanometer, micrometer, millimeter, centimeter, meter, kilometer (metric)
	- [x] fathom, nautical_mile (marine)
	- [x] hand, span, cubit, ell, rod, perch, chain, furlong, league (archaic)
	- [x] T_Unit_System: imperial, metric, marine, archaic
- [x] decide which is going to be the "storage units" — **millimeters** (like date/time in µs: store in mm, display per format rules)

