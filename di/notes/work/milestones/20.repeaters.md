# Repeaters

i want a way to automagically add/remove repeated elements like stairs (range for rise), studs (local building code)

## Examples

- stairs: template = one step (w, rise, run) → count = `total_height / rise`
- studs: template = one stud (w, h, thickness) → count = `wall_length / spacing` (rounded)

---

## Phase 1 — Data model

- [x] add `repeater: { count_formula: string } | null` to Smart_Object
- [x] add `is_template: boolean` flag to Smart_Object (marks the first child as the template)
- [x] serialize/deserialize both fields in Smart_Object

## Phase 2 — Engine: generate copies

- [x] `Engine.set_repeater(so, count_formula)` — compiles formula, marks SO as repeater
- [x] `Engine.sync_repeater(so)` — evaluates count, creates/removes cloned children to match
  - clones copy template's dimensions
  - each clone's position offset = template size × index (axis determined by template's largest dimension)
- [x] decompose: call `sync_repeater` after any propagation that touches a repeater SO

## Phase 3 — Constraints integration

- [x] when `propagate(so)` runs and `so` is a repeater, call `sync_repeater(so)` after
- [x] when `propagate_all()` runs, sync all repeater SOs after

## Phase 4 — UI

- [x] D_Selection: "repeat" button → opens inline count formula input
- [x] D_Selection: show count formula when SO is a repeater (editable)
- [x] D_List: badge repeated children with dim styling (e.g. `×3`)

## Phase 5 — Examples / test

- [ ] build a stairs preset in the library (step SO + repeater parent)
- [ ] build a studs preset (stud SO + repeater parent with code-derived spacing)

## Stairs

stairs repeat along a diagonal. first stair begins at (run, z = rise) -- NOT at origin. last step z = top - rise. the axis of run can be either 0 or 1, never 2 and needs a UX selector. also, rise needs a range that constrains the choice of rise dependent on the height of the (root) stairs SO

### Phase S1 — Data model

- [ ] expand repeater type: `{ count_formula: string, mode: 'linear' | 'stair', repeat_axis?: 0 | 1, rise_min?: number, rise_max?: number }`
- [ ] existing repeaters default to `mode: 'linear'` — no breakage
- [ ] serialize/deserialize new fields in Smart_Object
- [ ] migrate: v6→v7, bare `repeater` objects get `mode: 'linear'`

### Phase S2 — Engine: diagonal sync

- [ ] `resolve_rise(so)` — given total height and [rise_min, rise_max], find rise that divides evenly (or closest clean division)
- [ ] `sync_repeater` stair mode: each clone offset by `(run × i, rise × i)` along repeat_axis and z
- [ ] count = `total_height / resolved_rise`
- [ ] template positioned at (run, rise), not origin

### Phase S3 — UX

- [ ] repeat axis selector (x / y toggle) in D_Selection when mode = stair
- [ ] rise range inputs (min/max), prefilled 152.4 / 203.2 mm (6" / 8")
- [ ] display resolved rise value and step count

### Phase S4 — Preset

- [ ] build stairs .di file: root SO (stair envelope) + template step child + repeater with stair mode

### Phase S5 — Test

- [ ] verify staircase renders correctly with diagonal offsets
- [ ] verify rise clamps to range and count adjusts
- [ ] verify changing root height re-resolves rise and resyncs

## Studs

single-axis linear repeat with discrete spacing (12" / 16" / 24" OC). repeat axis is selectable (0 or 1, never 2). prepare the model for future additions: firewall blocking, diagonal bracing, diagonal studs

### Phase T1 — Data model

- [ ] add `mode: 'stud'` to repeater type: `'linear' | 'stair' | 'stud'`
- [ ] add `spacing?: number` to repeater (mm — 304.8 / 406.4 / 609.6)
- [ ] `repeat_axis` shared with stairs (already in S1)
- [ ] serialize/deserialize spacing field

### Phase T2 — Engine: stud sync

- [ ] `sync_repeater` stud mode: each clone offset by `spacing × i` along repeat_axis
- [ ] count = `wall_length / spacing` (rounded)
- [ ] template at origin, clones march along repeat_axis

### Phase T3 — UX

- [ ] spacing selector: 3-option segmented control (12" / 16" / 24") in D_Selection when mode = stud
- [ ] repeat axis selector (shared with stairs)
- [ ] display stud count

### Phase T4 — Preset

- [ ] build studs .di file: root SO (wall frame) + template stud child + repeater with stud mode

### Phase T5 — Test

- [ ] verify studs space correctly at each of the three spacings
- [ ] verify changing wall length adjusts stud count
- [ ] verify repeat axis toggle swaps direction

### Future (not now)

- [ ] firewall blocking: horizontal member at mid-height between studs
- [ ] diagonal bracing: angled member across stud bay
- [ ] diagonal studs: non-90° angles (rake walls)
